<!DOCTYPE html>
<html lang="en">
<head>
	<div id="main-head">
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<title>{{ title }}</title>
		<link rel="icon" type="image/x-icon" href="images/favicon.ico"/>
		<link rel='stylesheet' href='/stylesheets/style.css' />

		<!-- JQuery Bower -->
		<script type="text/javascript" src='/bower_components/jquery/dist/jquery.min.js'></script>

		<!-- Tether Bower (required for bootstrap 4.0.0) -->
		<link rel="stylesheet" href="/bower_components/tether/dist/css/tether.min.css">
		<script type="text/javascript" src="bower_components/tether/dist/js/tether.min.js"></script>

		<!-- Bootstrap Bower 4.0.0 -->
		<link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
		<script type="text/javascript" src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
	</div>
</head>

<body>
	<div id="navbar">
		<a target="_blank" href="https://acusense.ai/"><img id="fixed_logo" src="images/acusense-logo.png"></a>
		<div id="outerdiv" class="visible-lg" style="margin-top: 5px;">
			<input type="text" data-i-search-input="true" class="form-control" name="word" data-autocomplete="true" data-autocomplete-url="" placeholder="acusense ai search" id="search_bar"></input>
		</div>
		<br>

		<div id="tabs">
			<ul class="nav nav-tabs" id="tab_list">
				<li class="nav-item" id="photo_tab">
					<a class="nav-link active" id="photo_link" href="#">Photo</a>
				</li>
				<li class="nav-item" id="video_tab">
					<a class="nav-link" id="video_link" href="#">Video</a>
				</li>
			</ul>
		</div>
	</div>

	<br>
	<div id="resultdiv"></div>
	<div id='loading_gif'></div>
</body>

<script>
var searchRequest = null;

$(function () {
    var minlength = 0;

    $('.result').click(function (e){
    	var active_id = current_ID();
    	if (active_id == "photo_link") {
    		window.location.href = "filter";
    	} else { // active_id == "video_link"
    		window.location.href = "select_frame";
    	}
    })

    $("#search_bar").keyup(function () {
        var that = this,
        value = encodeURIComponent($(this).val());

        var active_id = current_ID();

        if (value.length >= minlength ) {
            if (searchRequest != null) 
                searchRequest.abort();
            if (active_id == 'photo_link') {
            	load_gif();
            	searchRequest = $.ajax({
            		type: "GET",
            		contentType: 'text/plain',
					crossDomain: true,
            		url: "https://api-hackathon-testino.acusense.ai/search/allimages/text/", // PHOTO SEARCH
            		data: {
            			'query' : value
            		},
            		dataType: 'text',
            		success: function(msg){
            			var json_obj = JSON.parse(msg);
            			var result = $("#resultdiv");
            			var innerdiv = $("<div>");
            			$.each(json_obj.images, function(index, element) {
        					innerdiv.append("<div id=\"padding\"><a><img class=\"result\" src=\"" + element.image_url + "\"></a></div>");
            			}); 
            			result.html(innerdiv);
            			remove_load_gif();
            		}
            	});

            } else { // active_id == 'video_link'
	            load_gif();
            	searchRequest = $.ajax({
            		type: "GET",
            		contentType: 'text/plain',
					crossDomain: true,
            		url: "https://api-hackathon-testino.acusense.ai/search/allvideos/text/", // VIDEO SEARCH
            		data: {
            			'query' : value
            		},
            		dataType: "text",
            		success: function(msg){
            			var json_obj = JSON.parse(msg);
            			sessionStorage.setItem("current_video_obj", JSON.stringify(json_obj));
            			var result = $("#resultdiv");
            			var innerdiv = $("<div>");
            			$.each(json_obj.videos, function(index, element) {
            				var timediv = $("<div>Clips: </div>");
        					$.each(element.clips, function(clip_index, clip_elem) {
        						timediv.append("<a style=\"display:inline\" id=\"time\" href=\"#\">" + clip_elem.start_time + "</a>");
        					}); 
        					innerdiv.append("<div id=\"outershell\"><div id=\"inner1\"><video id=\"videoID\" controls><source src=\"" + element.video_url + "\" type=\"video/mp4\">Your browser does not support the video tag.</video></div><div id=\"inner2\"><center>" + timediv[0].innerHTML + "</center></div></div><br><br>");
            			}); 
            			result.html(innerdiv);
						remove_load_gif();
            		}
            	});
            }
        } 
    });

	$("body").on("click", ".result", function(){
		var original = this.src;
		var parsed = original.split("/")[5];
		window.location = '/filter?image=' + encodeURIComponent(parsed);
	});

	$("body").on("click", "#time", function(e){
		var link = $(this).parent().parent();
		var video_shell = link.prev();
		var video = video_shell.find('video').get(0);
		video.currentTime = this.innerText;
		e.preventDefault();
	});

	$("body").on("click", 'video', function(){
		var videoURL = $(this).find("source").get(0).src;
		var temporary_result_obj = find_video_JSON(videoURL);
		sessionStorage.setItem("current_video_obj", JSON.stringify(temporary_result_obj)); // store for current session :)
		var current_time = $(this).get(0).currentTime;
		sessionStorage.setItem("current_video_time", current_time);
		window.location = '/select_frame?video=' + encodeURIComponent(videoURL);
	});

    $('#tab_list a').click(function (e) {
    	$(this).tab('show');
    	refresh_search(this.id);
    	// go to video tab or photo tab
    });
});

function find_video_JSON(url) {
    var objects = [];
    var session_video_obj = JSON.parse(sessionStorage.getItem("current_video_obj"));
    $.each(session_video_obj.videos, function(index, element) {
    	if (element.video_url == url) {
    		$.each(element.clips, function(clip_index, clip_elem) {
    			objects.push(clip_elem.start_time);
    		}); 
    	}
    }); 
    return objects;
}

function current_ID() {
	var active_tab = $('#tab_list a.active');
	var active_id = active_tab.get(0).id;
	return active_id;
};

function load_gif() {
	var gif = "/images/loading_gif.gif";
	$('#loading_gif').html("<img id=\"biggif\" src=\"" + gif + "\"></img>")
}

function remove_load_gif() {
	$('#loading_gif').empty();
}

function clear_search() {
	$("#resultdiv").empty();
}

function populate_image_search(query){
	load_gif();
	clear_search();
	searchRequest = $.ajax({
		type: "GET",
		contentType: 'text/plain',
		crossDomain: true,
		url: "https://api-hackathon-testino.acusense.ai/search/allimages/text/", // PHOTO SEARCH
		data: {
			'query' : query
		},
		dataType: 'text',
		success: function(msg){
			var json_obj = JSON.parse(msg);
			var result = $("#resultdiv");
			var innerdiv = $("<div>");
			$.each(json_obj.images, function(index, element) {
				innerdiv.append("<div id=\"padding\"><a><img class=\"result\" src=\"" + element.image_url + "\"></a></div>");
			}); 
			result.html(innerdiv);
			remove_load_gif();
		}
	});	
};

function populate_video_search(query){
	load_gif();
	clear_search();
	searchRequest = $.ajax({
		type: "GET",
		contentType: 'text/plain',
		crossDomain: true,
		url: "https://api-hackathon-testino.acusense.ai/search/allvideos/text/", // VIDEO SEARCH
		data: {
			'query' : query
		},
		dataType: "text",
		success: function(msg){
			var json_obj = JSON.parse(msg);
			sessionStorage.setItem("current_video_obj", JSON.stringify(json_obj));
			var result = $("#resultdiv");
			var innerdiv = $("<div>");
			$.each(json_obj.videos, function(index, element) {
				var timediv = $("<div>Clips: </div>");
				$.each(element.clips, function(clip_index, clip_elem) {
					timediv.append("<a style=\"display:inline\" id=\"time\" href=\"#\">" + clip_elem.start_time + "</a>");
				}); 
				innerdiv.append("<div id=\"outershell\"><div id=\"inner1\"><video id=\"videoID\" controls><source src=\"" + element.video_url + "\" type=\"video/mp4\">Your browser does not support the video tag.</video></div><div id=\"inner2\"><center>" + timediv[0].innerHTML + "</center></div></div><br><br>");
			}); 
			result.html(innerdiv);
			remove_load_gif();
		}
	});	
};

function refresh_search(id){
	var query = $('#search_bar').val();
	if (id == 'photo_link') {
		populate_image_search(query);
	} else { // id == 'video_link'
		populate_video_search(query);
	}
};
</script>

</html>