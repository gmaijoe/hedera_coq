<!DOCTYPE html>
<html lang="en">
<head>
	<div id="main-head">
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<title>{{ title }}</title>
        <link rel="icon" type="image/x-icon" href="images/favicon.ico"/>

		<link rel='stylesheet' href='/stylesheets/style.css' />

		<!-- JQuery Bower -->
		<script type="text/javascript" src='/bower_components/jquery/dist/jquery.min.js'></script>

		<!-- Tether Bower (required for bootstrap 4.0.0) -->
		<link rel="stylesheet" href="/bower_components/tether/dist/css/tether.min.css">
		<script type="text/javascript" src="bower_components/tether/dist/js/tether.min.js"></script>

		<!-- Bootstrap Bower 4.0.0 -->
		<link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
		<script type="text/javascript" src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
	</div>
</head>

<body>
    <a target="_blank" href="https://acusense.ai/"><img id="relative_logo" src="images/acusense-logo.png"></a>
    <center><h2>Select Video Frame</h2></center>
    <div id="video_div"></div>
    <br>
    <div style="padding: 20px;">
        <p style="display:inline">Video Time To Submit:&nbsp;</p>
        <p style="display:inline" id="currentT">0</p>
        <p style="display:inline">&nbsp;seconds</p>
    </div>
    <div class="wrapper">
        <form id="capture">
            <button type="submit" class="btn btn-primary">Capture Frame</button>
        </form>
    </div>
</body>

<script>

var videoURL = getQueryStringValue("video");
var session_stored_video_times = getVideoTimes("current_video_obj");
var session_stored_time = sessionStorage.getItem("current_video_time");
createVideo();
var video_elem = $('#video_div').find('video').get(0);
setVideoTime(session_stored_time);

function getQueryStringValue (key) {  
  return unescape(window.location.search.replace(new RegExp("^(?:.*[&\\?]" + escape(key).replace(/[\.\+\*]/g, "\\$&") + "(?:\\=([^&]*))?)?.*$", "i"), "$1"));  
}; 

function setVideoTime(start_time) {
    video_elem.currentTime = start_time;
};

function updateTime() {
    current_time = video_elem.currentTime;
    $('#currentT').html(current_time);

};

function getVideoTimes(key) {
    return JSON.parse(sessionStorage.getItem(key));
};

function createVideo() {
    var result = $("#video_div");
    var innerdiv = $("<div id=\"start_times\">");
    var timediv = $("<div>Clips: </div>");
    for (var i = 0; i < session_stored_video_times.length; i++){
        timediv.append("&nbsp;<a style=\"display:inline\" id=\"time\" href=\"#\">" + session_stored_video_times[i] + "</a>&nbsp;");
    }
    innerdiv.append("<div id=\"outershell\"><div id=\"inner1\"><video id=\"videoID\" controls><source src=\"" + videoURL + "\" type=\"video/mp4\">Your browser does not support the video tag.</video></div><div id=\"inner2\"><center>" + timediv[0].innerHTML + "</center></div></div><br><br>");
    result.html(innerdiv);
};  

function parseUrl(link) {
    return link.split("/")[5];
}; 

$(function(){
    $('body').on("click", "#start_times a", function(e){
        video_elem.currentTime = this.innerText;
        updateTime();
        e.preventDefault();
    });

    video_elem.addEventListener('playing', function(){
        console.log("playing");
        setInterval(updateTime, 80);
    });

    document.getElementById("capture").onsubmit=function() {
        var currentime = video_elem.currentime;
        var video_param = parseUrl(videoURL);

        // captureRequest = $.ajax({
        //         type: "GET",
        //         contentType: 'text/plain',
        //         crossDomain: true,
        //         url: "", // Capture Frame Request
        //         data: {
        //             'start' : currentime,
        //             'video_param' : video_param
        //         },
        //         dataType: "text",
        //         success: function(msg){
        //             var json_obj = JSON.parse(msg);
        //             var original = json_obj.original_url;
        //             var weird = json_obj.filtered_url;
        //             // loading gif
        //             window.location = '/share?url=' + encodeURIComponent(weird);
        //         }
        //     }); 

        // window.location = '/filter?image=' + encodeURIComponent(videoURL);
        return false;
    }
}); 
</script>

</html>